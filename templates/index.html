<!doctype html>

<head>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Administration interface for the N4O Knowledge Graph">

  <script src="assets/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/node_modules/jquery/dist/jquery.min.js"></script>
  <script src="assets/node_modules/ace-builds/src-min/ace.js"></script>

  <link rel="stylesheet" href="assets/style.css">
  <link rel="stylesheet" href="assets/node_modules/bootstrap/dist/css/bootstrap.min.css">

  <title>Knowledge Graph Workshop</title>
</head>

<body>
  <!-- Upload dialog for X3ML files (modal)-->
  <div class="modal fade" id="uploadFile" tabindex="-1" aria-labelledby="uploadFileLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadFileLabel">Upload turtle file</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="javascript:;" onsubmit="uploadTurtle( this )">
            <div class="input-group mb-3">
              <input type="file" class="form-control" name="file" accept=".ttl" required />
            </div>
            <div class="input-group mb-3">
              <input type="submit" class="btn btn-primary" data-bs-dismiss="modal" value="Submit" />&nbsp;
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dimiss</button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>
  <div class="alert alert-info" role="alert">
    <h4 class="alert-heading">Hello {{user['username']}}, welcome to the N4O-KG workshop!
      <a href="/logout">Log out</a>
    </h4>
    <hr>
    <div class="mb-3">

    </div>
    {% if error %}
    <div class="mb-3">
      <label for="ETA1" class="form-label">Error:</label>
      <textarea class="form-control" id="ETA1" rows="5" readonly>{{ error }}</textarea>
    </div>
    {% endif %}

    {% if success %}
    <div class="mb-3">
      <label for="RTA1" class="form-label">Result:</label>
      <textarea class="form-control" id="RTA1" rows="5" readonly>{{ success }}</textarea>
    </div>
    {% endif %}
  </div>
  <div id="app" class=".container-fluid" user_data="{{ user['profile_data'] }}" coll_index="{{ user['index'] }}">
    <div class="row">
      <div class="col">
        <h4>Lido source (xml)</h4>
        <p>
          <button type="button" class="btn btn-primary btn-sm" onclick="reset_editors()" id="REB">Reset</button>&nbsp;
          <button type="button" class="btn btn-danger btn-sm" onclick="convert_lido()" id="CLB">Convert</button>
        <div class="spinner-border text-primary" role="status" id="SP1"></div>
        </p>
        <div id="lidoEditor" style="height:600px"></div>
      </div>
      <div class="col">
        <h4>RDF Output (ttl)</h4>
        <p>
          <button type="button" class="btn btn-danger btn-sm" onclick="import_ttl()" id="ITB">Import</button>
          <button type="button" class="btn btn-primary btn-sm" onclick="rdfEditor.setValue('')" id="ITB">Clear</button>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFile">Upload file</button>
          The collection index is "{{ user['index'] }}"&nbsp;
        </p>
        <div id="rdfEditor" style="height:600px"></div>
      </div>
    </div>
  </div>

</body>
<script>
  document.getElementById("SP1").style.display = "none";

  function makeEditor(label, style = "ace/theme/monokai", fmt = "ace/mode/xml") {
    // Returns an ace editor object
    var ed = ace.edit(label);
    ed.setTheme(style);
    ed.session.setMode(fmt);
    ed.setPrintMarginColumn(-1);
    return ed;
  }

  var app_elem = document.getElementById('app');
  var user_data = app_elem.getAttribute('user_data', 'None');
  var coll_index = app_elem.getAttribute('coll_index', 'None');
  // Creator editors
  var lidoEditor = makeEditor("lidoEditor");
  var rdfEditor = makeEditor("rdfEditor", "", "ace/mode/turtle");

  function reset_editors() {
    lidoEditor.setValue(user_data);
    rdfEditor.setValue('');
  }

  function convert_lido() {
    document.getElementById("ITB").disabled = true;
    document.getElementById("SP1").style.display = "inline-block";
    rdfEditor.setValue('');
    fetch('/convert_lido', {
      method: 'POST',
      headers: {
        'Accept': 'application/json, text/plain, */*',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ "data": lidoEditor.getValue(), "format": "turtle" })
    })
      .then(response => response.text())
      .then(text => rdfEditor.setValue(text))
      .catch(err => console.error(err))
      .finally(() => {
        document.getElementById("ITB").disabled = false;
        document.getElementById("SP1").style.display = "none";
      });
  }

  function import_ttl(collection = "n4o") {
    var req = {
      method: 'POST',
      headers: {
        'Accept': 'application/json, text/plain, */*',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ "data": rdfEditor.getValue(), "coll_index": coll_index })
    }
    fetch('/import_ttl', req)
      .then(response => response.json())
      .then(json => console.log(json))
      .catch(err => console.error(err))
  }

  function uploadTurtle(form) {
    var fileInput = form.file;
    var file = fileInput.files[0];
    var reader = new FileReader();
    reader.onload = function (e) {
      var content = e.target.result;
      rdfEditor.setValue(content);
    };
    reader.readAsText(file);
  }

  reset_editors();
</script>

</html>